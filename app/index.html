<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Meemo</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <!-- Bootstrap -->
    <link href="resources/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="resources/css/font-awesome.min.css" rel="stylesheet">

    <link rel="stylesheet" href="css/index.min.css"/>
    <link rel="stylesheet" href="css/desktop.css"/>

  </head>
  <body id="application" @click="$refs.navbar.hideTags()">

    <navigation-bar :active-view="mainView" :tags="tags" :profile="profile" :search="search" :settings="settings" :archived="archived" v-ref:navbar></navigation-bar>

    <modal-settings id="modalSettings"></modal-settings>
    <modal-browser-extensions id="modalExtensions"></modal-browser-extensions>
    <modal-import id="modalImport"></modal-import>
    <modal-cheatsheet id="modalCheatSheet"></modal-cheatsheet>
    <modal-mailbox id="modalMailbox"></modal-mailbox>

    <div v-if="mainView === 'loader'" v-cloak>
      <view-loading></view-loading>
    </div>

    <div v-if="mainView === 'login'" v-cloak>
      <view-login></view-login>
    </div>

    <div v-show="mainView === 'content'" @drop="dropOrPasteHandler" @dragover="dragOver" v-cloak>
      <div :class="{ 'container': !settings.wide, 'container-fluid': settings.wide }">
        <div class="row">
          <div class="col-md-1" v-show="settings.showTagSidebar">
            <tag-sidebar :tags="tags"></tag-sidebar>
          </div>
          <div :class="{ 'col-md-10': !settings.wide, 'col-md-offset-1': (!settings.wide && !settings.showTagSidebar), 'col-md-11': (settings.wide && settings.showTagSidebar), 'col-md-12': (settings.wide && !settings.showTagSidebar) }">
            <div class="well" :class="{ edit: !!thingContent }" @click="giveAddFocus()" v-show="!archived">
              <div class="card-content align-right">
                <input id="addAttachment" type="file" @change="attachmentChanged($event)" class="hide" multiple>
                <div class="card-actions" v-show="thingContent">
                  <span>
                    <button class="btn btn-default" title="Insert Image" @click="triggerAttachmentUpload()"><i class="fa fa-image"></i></button>
                    &nbsp;
                    <a class="btn btn-default" title="Cheatsheet" href="#modalCheatSheet" data-toggle="modal"><i class="fa fa-keyboard-o"></i></a>
                    &nbsp;
                    <button class="btn btn-default" @click="addThing()" title="Add (Ctrl+S)"><i class="fa fa-check"></i></button>
                  </span>
                </div>
                <textarea id="addTextarea" class="new-thing" placeholder="Add something..." v-model="thingContent" :class="{ active: !!thingContent }" v-show="!busyAdd" @drop="dropOrPasteHandler" @dragover="preventEventBubble" @paste="dropOrPasteHandler"></textarea>
                <div class="propose-tags">
                  <div class="item" v-for="tag in tags | proposeTags thingContent '#addTextarea' true 1">
                    <a href="#" @click.prevent="activateProposedTag(tag)">#{{ tag.name }}</a>
                  </div>
                </div>
                <div v-show="busyAdd"><center><i class="spinner large"></i><br/><br/></center></div>
              </div>
            </div>
            <div v-show="archived">
                <h3 style="margin-top: 0">Archive</h3>
             </div>
            <div v-show="!busyThings">
              <thing v-for="item in things" :thing="item" :profile="profile" track-by="id"></thing>
              <view-loading v-show="busyFetchMore"></view-loading>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="guacamoly-settings-node" class="hide"></div>

    <script>
      window.nodeRequire = require;
      delete window.require;
      delete window.exports;
      delete window.module;
    </script>

    <script type="text/javascript" src="resources/jquery-1.12.3.min.js"></script>
    <script type="text/javascript" src="resources/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="resources/js/vue.min.js"></script>
    <script type="text/javascript" src="resources/js/shortcut.js"></script>
    <script type="text/javascript" src="resources/js/twemoji.min.js"></script>
    <script type="text/javascript" src="resources/js/markdown-it.min.js"></script>
    <script type="text/javascript" src="resources/js/markdown-it-emoji.min.js"></script>
    <script type="text/javascript" src="resources/js/superagent.js"></script>

    <script type="text/javascript" src="js/core.js"></script>

    <script type="text/template" id="navigation-bar-template">
  <div id="mainNavigationBar" class="navigation" :class="{ 'inverse': archived }">
    <div :class="{ 'container': (activeView === 'content' && !settings.wideNavbar), 'container-fluid': (activeView !== 'content' || settings.wideNavbar) }">
      <div class="row">
        <div class="shadow content" :class="{ 'col-md-10': (activeView === 'content' && !settings.wideNavbar), 'col-md-offset-1': (activeView === 'content' && !settings.wideNavbar) }">
          <div v-if="activeView === 'content'" class="input-group">
            <div class="input-group-btn">
              <!-- <button type="button" class="btn btn-default" title="Me">Me</button> -->
              <!-- <button type="button" class="btn btn-default" title="Friends">Friends</button> -->
              <button type="button" class="btn btn-default" @click.stop="toggleArchivedSearch()" title="{{ archived ? 'Show home feed' : 'Show archived feed' }}" :class="{ 'archive': archived }"><i class="fa" :class="{ 'fa-archive': !archived, 'fa-home': archived }"></i></button>
              <button type="button" class="btn btn-default" @click.stop="doSearch()" title="Search"><i class="fa fa-search"></i></button>
            </div>
            <input type="text" class="form-control search" id="searchBarInput" autocomplete="off" placeholder="Search..." v-model="search" @click.stop="showTags()" @keyup="handleSearchKeyInput(this, $event)" @keyup.enter="doSearch()" @drop="preventEventBubble" @dragover="preventEventBubble" @paste="preventEventBubble">
            <div class="dropdown-tags" id="tagsDropdown">
              <div class="item" v-for="tag in tags | proposeTags search '#searchBarInput'">
                <a href="#" id="tagItem" @click.prevent="activateProposedTag(tag)" @keydown.stop.prevent="keyNavigateTags(this, tag, $event)">#{{ tag.name }}</a>
              </div>
            </div>
            <div class="input-group-btn">
              <button type="button" class="btn btn-default hidden-xs hidden-sm" @click.stop="clearSearch()" title="Clear"><i class="fa fa-times"></i></button>
              <button type="button" class="btn btn-default dropdown-toggle hidden-xs hidden-sm" data-toggle="dropdown">{{ profile.displayName || profile.username || profile.email }} <b class="caret"></b></button>
              <button type="button" class="btn btn-default dropdown-toggle hidden-md hidden-lg" data-toggle="dropdown"><i class="fa fa-bars"></i></button>
              <ul class="dropdown-menu settings-menu">
                  <li><a href="#modalSettings" data-toggle="modal">Settings</a></li>
                  <li><a class="external" href="/public/{{ profile.id }}" target="_blank">Public Feed</a></li>
                  <li><a href="#modalExtensions" data-toggle="modal">Browser Extensions</a></li>
                  <li><a href="#modalCheatSheet" data-toggle="modal">Cheatsheet</a></li>
                  <li v-show="$root.mailbox"><a href="#modalMailbox" data-toggle="modal">Mailbox</a></li>
                  <li><a class="external" href="/api/rss/{{ profile.id }}" target="_blank">RSS Feed</a></li>
                  <li class="divider"></li>
                  <li><a href="#" data-toggle="modal" data-target="#modalImport">Import</a></li>
                  <li><a href="#" @click.prevent="exportThings()">Export</a></li>
                  <li class="divider"></li>
                  <li><a class="external" href="https://meemo.minimal-space.de" target="_blank">About</a></li>
                  <li><a href="#" @click.prevent="toggleDevTools()">Toggle Dev-Tools</a></li>
                  <li><a href="#" @click.prevent="logout()">Logout</a></li>
                </ul>
            </div>
          </div>
          <div v-else>
            <a href="" class="btn btn-default">Meemo</a>
            <a href="https://meemo.minimal-space.de" target="_blank" class="btn btn-default pull-right">About</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/javascript">'use strict';

/* global Vue */

Vue.component('navigation-bar', {
    template: '#navigation-bar-template',
    data: function () {
        return {};
    },
    props: {
        search: {
            type: String,
            required: true
        },
        archived: {
            type: Boolean,
            required: true
        },
        activeView: {
            type: String,
            required: true
        },
        tags: {
            type: Array,
            required: true
        },
        profile: {
            type: Object,
            required: true
        },
        settings: {
            type: Object,
            required: true
        }
    },
    methods: {
        logout: function () {
            this.$root.Core.session.logout();
        },
        handleSearchKeyInput: function (element, event) {
            if (event.code === 'Escape') {
                $('#tagsDropdown').hide();
            } else {
                $('#tagsDropdown').show();
                if (event.code === 'ArrowDown' &&  $('.dropdown-tags>.item>a')[0]) $('.dropdown-tags>.item>a')[0].focus();
            }
        },
        showTags: function () {
            $('#tagsDropdown').show();
        },
        hideTags: function () {
            $('#tagsDropdown').hide();
        },
        keyNavigateTags: function (element, tag, event) {
            var tagColumns = 4;
            var index = element.$index;

            switch (event.code) {
                case 'Enter':
                    this.activateProposedTag(tag);
                    return;
                case 'ArrowRight':
                    ++index;
                    break;
                case 'ArrowLeft':
                    --index;
                    break;
                case 'ArrowUp':
                    if (index < tagColumns) {
                        Vue.nextTick(function () { $('#searchBarInput').focus(); });
                        return;
                    }
                    index -= tagColumns;
                    break;
                case 'ArrowDown':
                    index += tagColumns;
                    break;
                case 'Escape':
                    $('#tagsDropdown').hide();
                    $('#searchBarInput').focus();
                    break;
                default: return;
            }

            if ($('.dropdown-tags>.item>a')[index]) {
                Vue.nextTick(function () { $('.dropdown-tags>.item>a')[index].focus(); });
            }
        },
        activateProposedTag: function (tag) {
            var word = Vue.getCurrentSearchWord(this.search, $('#searchBarInput'));

            if (!word) this.search += '#' + tag.name;
            else this.search = this.search.replace(Vue.getCurrentSearchWord(this.search, $('#searchBarInput')), '#' + tag.name);

            this.$root.refresh(this.search);
            Vue.nextTick(function () { $('#searchBarInput').focus(); });
        },
        doSearch: function () {
            $('#tagsDropdown').hide();
            this.$root.refresh(this.search);
        },
        toggleArchivedSearch: function () {
            this.$root.archived = !this.$root.archived;
            this.$root.refresh(this.search);
        },
        clearSearch: function () {
            this.$root.refresh('');
            Vue.nextTick(function () { $('#searchBarInput').focus(); });
        },
        exportThings: function () {
            this.$root.Core.things.export();
        },
        toggleDevTools: function () {
            nodeRequire('electron').ipcRenderer.send('toggle-dev-tools')
        },
        // prevent from bubbling up to the main drop handler to allow textarea drops and paste
        preventEventBubble: function (event) {
            event.cancelBubble = true;
        }
    },
    ready: function () {

    }
});
</script>

    <script type="text/template" id="tag-sidebar-template">
  <div class="tag-sidebar">
    <a v-for="tag in tags | popularTags" href="#search?#{{ tag.name }}" class="item" title="#{{ tag.name }}">#{{ tag.name }}</a>
  </div>
</script>

<script type="text/javascript">'use strict';

/* global Vue */

Vue.component('tag-sidebar', {
    template: '#tag-sidebar-template',
    data: function () {
        return {};
    },
    props: {
        tags: {
            type: Array,
            required: true
        },
        settings: {
            type: Object,
            required: true
        }
    },
    methods: {

    },
    ready: function () {

    }
});
</script>

    <script type="text/template" id="modal-settings-template">
  <div class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
          <h4>Settings</h4>
        </div>
        <div class="modal-body settings">
          <form class="form-horizontal" @submit.prevent="save()">
            <div class="form-group">
              <label class="col-xs-3 control-label">Title</label>
              <div class="col-xs-8">
                <input type="text" class="form-control" v-model="title" placeholder="Title" />
              </div>
            </div>
            <div class="form-group">
              <label class="col-xs-3 control-label">Display</label>
              <div class="col-xs-8">
                <input type="checkbox" v-model="wide" id="settingsCheckboxWideNotes"/>
                <label class="control-label" for="settingsCheckboxWideNotes">Wide notes</label>
              </div>
              <div class="col-xs-8 col-xs-offset-3">
                <input type="checkbox" v-model="wideNavbar" id="settingsCheckboxWideNavbar"/>
                <label class="control-label" for="settingsCheckboxWideNavbar">Wide toolbar</label>
              </div>
              <div class="col-xs-8 col-xs-offset-3">
                <input type="checkbox" v-model="publicBackground" id="settingsCheckboxPublicBackground"/>
                <label class="control-label" for="settingsCheckboxPublicBackground">Show background image on public feed</label>
              </div>
              <div class="col-xs-8 col-xs-offset-3">
                <input type="checkbox" v-model="showTagSidebar" id="settingsCheckboxTagSidebar"/>
                <label class="control-label" for="settingsCheckboxTagSidebar">Show most used tags in sidebar</label>
              </div>
            </div>
            <div class="form-group">
              <label class="col-xs-3 control-label">Behavior</label>
              <div class="col-xs-8">
                <input type="checkbox" v-model="keepPositionAfterEdit" id="settingsCheckboxKeepPos"/>
                <label class="control-label" for="settingsCheckboxKeepPos">Keep scroll position after edit</label>
              </div>
            </div>
            <div class="form-group">
              <label class="col-xs-3 control-label">Background</label>
              <div class="col-xs-8">
                <div class="image-picker" @click="backgroundImageFileTrigger()" v-bind:style="{ backgroundImage: backgroundImage }" title="Click to set background image">
                  <div class="placeholder" v-show="!backgroundImageDataUrl">Click to set background image</div>
                </div>
                <input type="file" class="hide" id="backgroundImageInput" @change="backgroundImageFileChanged($event)" accept="image/*"/>
                <div v-show="backgroundImageError" class="text-error">{{ backgroundImageError }}</div>
                <a href="#" @click.stop.prevent="removeBackgroundImage()" v-show="backgroundImageDataUrl">Clear background image</a>
              </div>
            </div>
            <input type="submit" class="hide" />
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button class="btn btn-success" @click="save()"><i class="spinner alt" v-show="busy"></i> Save</button>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/javascript">'use strict';

/* global Vue */

Vue.component('modal-settings', {
    template: '#modal-settings-template',
    data: function () {
        return {
            busy: false,
            title: '',
            backgroundImage: '',
            backgroundImageDataUrl: '',
            backgroundImageError: null,
            wide: false,
            wideNavbar: true,
            keepPositionAfterEdit: false,
            publicBackground: false,
            showTagSidebar: false
        };
    },
    methods: {
        onShow: function () {
            this.busy = false;
            this.title = this.$root.settings.title;
            this.backgroundImageDataUrl = this.$root.settings.backgroundImageDataUrl;
            this.backgroundImage = 'url("' + this.$root.settings.backgroundImageDataUrl + '")';
            this.wide = this.$root.settings.wide;
            this.wideNavbar = this.$root.settings.wideNavbar;
            this.keepPositionAfterEdit = this.$root.settings.keepPositionAfterEdit;
            this.publicBackground = this.$root.settings.publicBackground;
            this.showTagSidebar = this.$root.settings.showTagSidebar;
        },
        onHide: function () {
            this.busy = false;
            this.title = '';
            this.backgroundImageDataUrl = '';
            this.backgroundImage = '';
            this.wide = false;
            this.wideNavbar = true;
            this.keepPositionAfterEdit = false;
            this.publicBackground = false;
            this.showTagSidebar = false;
        },
        save: function () {
            var that = this;
            var data = {
                title: this.title,
                backgroundImageDataUrl: this.backgroundImageDataUrl,
                wide: this.wide,
                wideNavbar: this.wideNavbar,
                keepPositionAfterEdit: this.keepPositionAfterEdit,
                publicBackground: this.publicBackground,
                showTagSidebar: this.showTagSidebar
            };

            this.busy = true;
            this.$root.Core.settings.save(data, function (error) {
                that.busy = false;

                if (error) return console.error(error);

                $(that.$el).modal('hide');
            });
        },
        removeBackgroundImage: function () {
            this.backgroundImage = '';
            this.backgroundImageDataUrl = '';
        },
        backgroundImageFileTrigger: function () {
            $('#backgroundImageInput').click();
        },
        backgroundImageFileChanged: function (event) {
            var that = this;

            that.backgroundImageError = null;

            // limit to 5MB keep in sync with app.js body-parser limits
            if (event.target.files[0].size > 1024 * 1024 * 5) {
                that.backgroundImageError = 'This image is too large. Maximum size is 5MB.';
                return;
            }

            var reader = new FileReader();
            reader.onload = function (e) {
                that.backgroundImageDataUrl = reader.result;
                that.backgroundImage = 'url(" ' + reader.result + '")';
            };

            reader.readAsDataURL(event.target.files[0]);
        }
    },
    ready: function () {
        $(this.$el).on('show.bs.modal', this.onShow);
        $(this.$el).on('hide.bs.modal', this.onHide);
    }
});
</script>

    <script type="text/template" id="modal-browser-extensions-template">
  <div class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
          <h4>Browser Extensions</h4>
        </div>
        <div class="modal-body">
          <p>
            <a class="btn btn-success btn-raised" href="https://chrome.google.com/webstore/detail/guacamoly/lhkjapedcimeeiildlmebipnekekjmod" target="_blank">Google Chrome</a>
            <a class="btn btn-success btn-raised" href="https://addons.mozilla.org/en-US/firefox/addon/guacamoly/" target="_blank">Firefox</a>
            <br/><br/>
            <a href="mailto:johannes@nebulon.de">Let us know if you would need an extension for another browser.</a>
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/javascript">'use strict';

/* global Vue */

Vue.component('modal-browser-extensions', {
    template: '#modal-browser-extensions-template'
});
</script>

    <script type="text/template" id="modal-cheatsheet-template">
  <div class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
          <h4>Markdown Cheatsheet</h4>
        </div>
        <div class="modal-body">
          <pre>
Emphasis:
*italic*
**bold**
~~strikethrough~~

Heading:
# heading
## heading2
### heading3

Horizontal line:
___


Blockquotes:
> Quotes
>> more Quotes


Lists:
* blabla
* more of this awesomeness
* fantastic stuff

1. one
2. two
3. three


Emojis:
:-)
:fish:

Code:
```
function () {
    alert('Hello World');
}
```

Text Colors:
choose the color with :<color>: and reset after that with :clear:
Example :blue: Blue text :clear: regular text color

Tables:
| Tables        | Are           | Cool  |
| ------------- |:-------------:| -----:|
| col 3 is      | right-aligned | $1600 |
| col 2 is      | centered      |   $12 |
| zebra stripes | are neat      |    $1 |

Checkboxes:
[ ] Select this
[x] And select that

          </pre>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/javascript">'use strict';

/* global Vue */

Vue.component('modal-cheatsheet', {
    template: '#modal-cheatsheet-template'
});
</script>

    <script type="text/template" id="modal-mailbox-template">
  <div class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
          <h4>Mailbox</h4>
        </div>
        <div class="modal-body">
          Guacamoly supports receiving mails and will convert them into notes.<br/>
          <br/>
          Just send a mail to <a href="mailto: {{ $root.mailbox }}">{{ $root.mailbox }}</a> and it will appear after some time in your feed.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/javascript">'use strict';

/* global Vue */

Vue.component('modal-mailbox', {
    template: '#modal-mailbox-template',
    data: function () {
    	return {};
    },
    ready: function () {
    }
});
</script>

    <script type="text/template" id="modal-import-template">
  <div class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" @click="cancel()"><span>&times;</span></button>
          <h4>Import</h4>
        </div>
        <div class="modal-body">
          <p>
            <div v-show="!importFile">
              <input type="file" @change="fileChanged($event)">
            </div>
            <div v-else>
              <p>This will add all data from <b>{{ importFile.name }}</b> to your current set.</p>
              <a href="#" @click.prevent="importFile = null;">Choose other file</a>
            </div>
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" @click="cancel()">Cancel</button>
          <button class="btn btn-success" :disabled="!importFile" @click="import()">Import</button>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/javascript">'use strict';

/* global Vue */

Vue.component('modal-import', {
    template: '#modal-import-template',
    data: function () {
        return {
            importFile: null
        };
    },
    methods: {
        fileChanged: function (event) {
            this.importFile = event.target.files[0];
        },
        import: function () {
            var that = this;
            var data = new FormData();
            data.append('import', this.importFile);

            this.$root.Core.things.import(data, function (error) {
                if (error) console.error(error);

                $(that.$el).modal('hide');

                that.importFile = null;
            });
        },
        cancel: function () {
            this.importFile = null;
            $(this.$el).modal('hide');
        }
    }
});
</script>

    <script type="text/template" id="view-login-template">
  <div>
    <br/>
    <br/>
    <div class="container">
      <div class="row">
        <div class="col-md-4 col-md-offset-4 white-boxes shadow">
          <h3>Login</h3>
          <form @submit.prevent="login()">
            <div class="form-group" :class="{ 'has-error': error }">
              <label class="control-label">Domain</label>
              <input type="text" class="form-control" id="inputDomain" v-model="domain" :disabled="busy" required autofocus/>
            </div>
            <div class="form-group" :class="{ 'has-error': error }">
              <label class="control-label">Username</label>
              <input type="text" class="form-control" id="inputUsername" v-model="username" :disabled="busy" required autofocus/>
            </div>
            <div class="form-group" :class="{ 'has-error': error }">
              <label class="control-label">Password</label>
              <input type="password" class="form-control" v-model="password" :disabled="busy" required/>
            </div>
            <button type="submit" class="btn btn-success" :disabled="busy"><i class="spinner alt" v-show="busy"></i> Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/javascript">'use strict';

/* global Vue */

Vue.component('view-login', {
    template: '#view-login-template',
    data: function () {
        return {
            busy: false,
            error: false,
            username: '',
            password: '',
            users: []
        };
    },
    methods: {
        login: function () {
            var that = this;

            that.busy = true;
            that.error = false;

            that.$root.Core.session.login(that.username, that.password, that.domain, function (error, user) {
                that.busy = false;

                if (error) {
                    that.error = true;
                    that.username = '';
                    that.password = '';
                    that.domain = '';

                    Vue.nextTick(function () { $('#inputUsername').focus(); });

                    return console.error('Login failed:', error.status ? error.status : error);
                }

                that.error = false;

                // TODO should be a signal/slot
                that.$root.main();
            });
        }
    },
    ready: function () {
        var that = this;

        if (window.host) {

          this.$root.Core.users.list(function (error, result) {
            that.users = result;
            console.log(result)
          });

          Vue.nextTick(function () { $('#inputUsername').focus(); });
        }
    }
});
</script>

    <script type="text/template" id="view-loading-template">
  <div>
    <br/>
    <br/>
    <center>
      <i class="spinner large"></i>
    </center>
    <br/>
    <br/>
  </div>
</script>

<script type="text/javascript">'use strict';

/* global Vue */

Vue.component('view-loading', {
    template: '#view-loading-template'
});
</script>

    <script type="text/template" id="thing-template">

  <div class="modal fade" id="modalShare-{{ thing.id }}">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
        </div>
        <div class="modal-body">
          This note is publicly available at <a href="{{ shareLink }}" target="_blank">{{ shareLink }}</a>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalArchive-{{ thing.id }}">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
        </div>
        <div class="modal-body">
          <h4>What do you want to do with this Note?</h4>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger btn-outline pull-left" @click="deleteThing()">Delete permanently</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" @click="toggleArchive()">Archive</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalDel-{{ thing.id }}">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
        </div>
        <div class="modal-body">
          <h4>Do you want to delete this Note permanently?</h4>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
          <button type="button" class="btn btn-danger" @click="deleteThing()">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <div class="well" id="card-{{ thing.id }}" :class="{ edit: thing.edit }">
    <div class="card-actions">
      {{ thing.createdAt | prettyDateOffset }}
      <span v-show="thing.edit">
        <button class="btn btn-default" title="Insert Image" @click="triggerUploadFileInput()"><i class="fa fa-image"></i></button>
        &nbsp;
        <a class="btn btn-default" title="Cheatsheet" href="#modalCheatSheet" data-toggle="modal"><i class="fa fa-keyboard-o"></i></a>
        &nbsp;
        <button class="btn btn-default" @click="cancelEdit()" title="Cancel"><i class="fa fa-times"></i></button>
        &nbsp;
        <button class="btn btn-default" @click="saveEdit()" title="Save (Ctrl+S)"><i class="fa fa-check"></i></button>
      </span>
      <span v-show="!thing.edit">
        <button class="btn btn-default" @click="togglePublic()" title="{{ thing.public ? 'Make private' : 'Make public' }}" v-show="!thing.archived"><i class="fa" :class="{ 'fa-eye': thing.public, 'fa-eye-slash': !thing.public }"></i></button>
        <button class="btn btn-default" @click="showShareLink()" title="Share" v-show="!thing.archived"><i class="fa fa-share-alt"></i></button>
        <button class="btn btn-default" @click="showArchive()" title="Archive or delete" v-show="!thing.archived"><i class="fa fa-trash"></i></button>
        <button class="btn btn-default" @click="showDelete()" title="Delete" v-show="thing.archived"><i class="fa fa-trash"></i></button>
        <button class="btn btn-default" @click="toggleArchive()" title="Restore from archive" v-show="thing.archived"><i class="fa fa-reply"></i></button>
        <button class="btn btn-default" @click="showEdit()" title="Edit"><i class="fa fa-pencil"></i></button>
      </span>
    </div>
    <div class="card-content">
      <input type="file" id="fileUpload-{{ thing.id }}" @change="uploadFileChanged($event)" class="hide" multiple>
      <div v-show="!busy && thing.edit" @dragover="preventEventBubble" @drop="dropOrPasteHandler" @paste="dropOrPasteHandler"><textarea v-model="thing.content" id="{{ 'textarea-' + thing.id }}" style="height: 200px" @keyup.esc.stop.prevent="cancelEdit()"></textarea></div>
      <div class="thing-content" v-show="!busy && !thing.edit">{{{ thing.richContent | markdown }}}</div>
      <div class="propose-tags" v-show="thing.edit">
        <div class="item" v-for="tag in $root.tags | proposeTagsThingsEdit thing.content thing.id">
          <a href="#" @click.prevent="activateProposedTag(tag)">#{{ tag.name }}</a>
        </div>
      </div>
      <div v-show="busy"><center><i class="spinner large"></i><br/><br/></center></div>
    </div>
  </div>
</script>

<script type="text/javascript">'use strict';

/* global Vue */
/* global shortcut */

Vue.component('thing', {
    template: '#thing-template',
    data: function () {
        return {
            shareLink: '',
            busy: false
        };
    },
    props: {
        thing: {
            type: Object,
            required: true
        },
        profile: {
            type: Object,
            required: true
        }
    },
    methods: {
        showEdit: function () {
            var id = this.thing.id;

            this.thing.edit = true;

            Vue.nextTick(function() {
                var margin = 20;

                $('#textarea-' + id).focus();
                $('#textarea-' + id).height($(window).height() - $('#mainNavigationBar').height() - (margin*2) - 60 - 20);

                window.scroll(0, $('#card-' + id).offset().top - $('#mainNavigationBar').height() - margin);
            });
        },
        saveEdit: function () {
            var that = this;

            this.busy = true;

            this.$root.Core.things.edit(this.thing, function (error, result) {
                that.busy = false;

                if (error) return console.error(error);

                // update the enhanced content from the server
                that.thing.richContent = result.richContent;
                that.thing.edit = false;

                // edited item is now on top
                if (!that.$root.settings.keepPositionAfterEdit) {
                    Vue.nextTick(function () { window.scrollTo(0,0); });
                }

                that.$root.refreshTags();
                window.Guacamoly.disableCheckboxes();
            });
        },
        cancelEdit: function () {
            this.thing.edit = false;
        },
        showArchive: function () {
            $('#modalArchive-' + this.thing.id).modal('show');
        },
        showDelete: function () {
            $('#modalDel-' + this.thing.id).modal('show');
        },
        deleteThing: function () {
            var that = this;

            this.$root.Core.things.del(this.thing, function (error) {
                if (error) return console.error(error);

                $('#modalArchive-' + that.thing.id).modal('hide');
                $('#modalDel-' + that.thing.id).modal('hide');
            });
        },
        showShareLink: function () {
            var that = this;

            this.thing.shared = true;

            this.$root.Core.things.edit(this.thing, function (error) {
                if (error) return console.error(error);

                that.shareLink = location.origin + '/shared.html?userId=' + that.$root.profile.id + '&id=' + that.thing.id;

                $('#modalShare-' + that.thing.id).modal('show');
            });
        },
        togglePublic: function () {
            var that = this;

            this.thing.public = !this.thing.public;

            this.$root.Core.things.edit(this.thing, function (error) {
                if (error) return console.error(error);

                that.shareLink = '';
            });
        },
        toggleArchive: function () {
            var that = this;

            this.busy = true;

            this.thing.archived = !this.thing.archived;
            this.thing.public = this.thing.archived ? false : this.thing.public;

            this.$root.Core.things.edit(this.thing, function (error) {
                that.busy = false;
                if (error) return console.error(error);
                $('#modalArchive-' + that.thing.id).modal('hide');
            });
        },
        uploadFileChanged: function (event) {
            var that = this;

            var data = event.target.files;

            for (var i = 0; i < data.length; ++i) {
                var formData = new FormData();
                formData.append('file', event.target.files[i]);

                this.$root.Core.things.uploadFile(formData, function (error, result) {
                    if (error) console.error(error);

                    that.thing.content += ' [' + result.fileName + '] ';
                    that.thing.attachments.push(result);
                });
            }
        },
        triggerUploadFileInput: function () {
            $('#fileUpload-' + this.thing.id).click();
        },
        activateProposedTag: function (tag) {
            var that = this;

            var word = Vue.getCurrentSearchWord(this.thing.content, $('#textarea-' + this.thing.id));
            if (!word) return console.log('nothing to add');

            var cursorPosition = $('#textarea-' + this.thing.id)[0].selectionStart;

            this.thing.content = this.thing.content.replace(new RegExp(word, 'g'), function (match, offset) {
                return ((cursorPosition - word.length) === offset) ? ('#' + tag.name) : match;
            });

            Vue.nextTick(function () { $('#textarea-' + that.thing.id).focus(); });
        },
        // prevent from bubbling up to the main drop handler to allow textarea drops
        preventEventBubble: function (event) {
            event.cancelBubble = true;
        },
        dropOrPasteHandler: function (event) {
            event.cancelBubble = false;
            var that = this;

            var data;
            if (event.type === 'paste') data = event.clipboardData.items;
            else if (event.type === 'drop') data = event.dataTransfer.items;
            else return;

            for (var i = 0; i < data.length; ++i) {
                if (data[i].kind === 'file') {
                    var formData = new FormData();
                    var file = data[i].getAsFile();

                    // find unused filename
                    var j = 0;
                    var name = file.name;
                    while (that.thing.content.indexOf(name) !== -1) {
                        name = j + '_' + file.name;
                        ++j;
                    }
                    formData.append('file', file, name);

                    this.$root.Core.things.uploadFile(formData, function (error, result) {
                        if (error) console.error(error);

                        that.thing.content += ' [' + result.fileName + '] ';
                        that.thing.attachments.push(result);
                    });

                    event.cancelBubble = true;
                    event.preventDefault();
                }
            }
        }
    },
    ready: function () {
        shortcut.add('Ctrl+s', this.saveEdit.bind(this), { target: 'textarea-' + this.thing.id });
        shortcut.add('Ctrl+Enter', this.saveEdit.bind(this), { target: 'textarea-' + this.thing.id });

        window.Guacamoly.disableCheckboxes();
    }
});
var shell = nodeRequire('electron').shell
$(document).on('click', '.external', function(event) {
  event.preventDefault();
  shell.openExternal(window.host + $(this).attr('href'));
})
</script>
    <script type="text/javascript" src="js/util.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
  </body>
</html>
